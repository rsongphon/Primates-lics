# PostgreSQL Exporter Custom Queries
# Extended monitoring queries for LICS PostgreSQL database

pg_replication:
  query: "SELECT EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp())) as lag"
  master: true
  metrics:
    - lag:
        usage: "GAUGE"
        description: "Replication lag behind master in seconds"

pg_postmaster:
  query: "SELECT pg_postmaster_start_time as start_time_seconds from pg_postmaster_start_time()"
  master: true
  metrics:
    - start_time_seconds:
        usage: "GAUGE"
        description: "Time at which postmaster started"

pg_stat_user_tables:
  query: |
    SELECT
      schemaname,
      relname,
      seq_scan,
      seq_tup_read,
      idx_scan,
      idx_tup_fetch,
      n_tup_ins,
      n_tup_upd,
      n_tup_del,
      n_tup_hot_upd,
      n_live_tup,
      n_dead_tup,
      n_mod_since_analyze,
      COALESCE(last_vacuum, '1970-01-01Z'),
      COALESCE(last_autovacuum, '1970-01-01Z'),
      COALESCE(last_analyze, '1970-01-01Z'),
      COALESCE(last_autoanalyze, '1970-01-01Z'),
      vacuum_count,
      autovacuum_count,
      analyze_count,
      autoanalyze_count
    FROM pg_stat_user_tables
  metrics:
    - schemaname:
        usage: "LABEL"
        description: "Name of the schema that this table is in"
    - relname:
        usage: "LABEL"
        description: "Name of this table"
    - seq_scan:
        usage: "COUNTER"
        description: "Number of sequential scans initiated on this table"
    - seq_tup_read:
        usage: "COUNTER"
        description: "Number of live rows fetched by sequential scans"
    - idx_scan:
        usage: "COUNTER"
        description: "Number of index scans initiated on this table"
    - idx_tup_fetch:
        usage: "COUNTER"
        description: "Number of live rows fetched by index scans"
    - n_tup_ins:
        usage: "COUNTER"
        description: "Number of rows inserted"
    - n_tup_upd:
        usage: "COUNTER"
        description: "Number of rows updated"
    - n_tup_del:
        usage: "COUNTER"
        description: "Number of rows deleted"
    - n_tup_hot_upd:
        usage: "COUNTER"
        description: "Number of rows HOT updated"
    - n_live_tup:
        usage: "GAUGE"
        description: "Estimated number of live rows"
    - n_dead_tup:
        usage: "GAUGE"
        description: "Estimated number of dead rows"
    - n_mod_since_analyze:
        usage: "GAUGE"
        description: "Estimated number of rows changed since last analyze"
    - last_vacuum:
        usage: "GAUGE"
        description: "Last time at which this table was manually vacuumed"
    - last_autovacuum:
        usage: "GAUGE"
        description: "Last time at which this table was vacuumed by the autovacuum daemon"
    - last_analyze:
        usage: "GAUGE"
        description: "Last time at which this table was manually analyzed"
    - last_autoanalyze:
        usage: "GAUGE"
        description: "Last time at which this table was analyzed by the autovacuum daemon"
    - vacuum_count:
        usage: "COUNTER"
        description: "Number of times this table has been manually vacuumed"
    - autovacuum_count:
        usage: "COUNTER"
        description: "Number of times this table has been vacuumed by the autovacuum daemon"
    - analyze_count:
        usage: "COUNTER"
        description: "Number of times this table has been manually analyzed"
    - autoanalyze_count:
        usage: "COUNTER"
        description: "Number of times this table has been analyzed by the autovacuum daemon"

pg_statio_user_tables:
  query: |
    SELECT
      schemaname,
      relname,
      heap_blks_read,
      heap_blks_hit,
      idx_blks_read,
      idx_blks_hit,
      toast_blks_read,
      toast_blks_hit,
      tidx_blks_read,
      tidx_blks_hit
    FROM pg_statio_user_tables
  metrics:
    - schemaname:
        usage: "LABEL"
        description: "Name of the schema that this table is in"
    - relname:
        usage: "LABEL"
        description: "Name of this table"
    - heap_blks_read:
        usage: "COUNTER"
        description: "Number of disk blocks read from this table"
    - heap_blks_hit:
        usage: "COUNTER"
        description: "Number of buffer hits in this table"
    - idx_blks_read:
        usage: "COUNTER"
        description: "Number of disk blocks read from all indexes on this table"
    - idx_blks_hit:
        usage: "COUNTER"
        description: "Number of buffer hits in all indexes on this table"
    - toast_blks_read:
        usage: "COUNTER"
        description: "Number of disk blocks read from this table's TOAST table"
    - toast_blks_hit:
        usage: "COUNTER"
        description: "Number of buffer hits in this table's TOAST table"
    - tidx_blks_read:
        usage: "COUNTER"
        description: "Number of disk blocks read from this table's TOAST table indexes"
    - tidx_blks_hit:
        usage: "COUNTER"
        description: "Number of buffer hits in this table's TOAST table indexes"

pg_database:
  query: |
    SELECT
      pg_database.datname,
      pg_database_size(pg_database.datname) as size_bytes
    FROM pg_database
  master: true
  cache_seconds: 30
  metrics:
    - datname:
        usage: "LABEL"
        description: "Name of the database"
    - size_bytes:
        usage: "GAUGE"
        description: "Disk space used by the database"

# TimescaleDB specific metrics
pg_hypertable:
  query: |
    SELECT
      schema_name,
      table_name,
      num_dimensions,
      num_chunks,
      compression_enabled,
      compressed_heap_size,
      uncompressed_heap_size
    FROM timescaledb_information.hypertables
  master: true
  metrics:
    - schema_name:
        usage: "LABEL"
        description: "Schema of the hypertable"
    - table_name:
        usage: "LABEL"
        description: "Name of the hypertable"
    - num_dimensions:
        usage: "GAUGE"
        description: "Number of dimensions"
    - num_chunks:
        usage: "GAUGE"
        description: "Number of chunks"
    - compression_enabled:
        usage: "GAUGE"
        description: "Is compression enabled"
    - compressed_heap_size:
        usage: "GAUGE"
        description: "Compressed heap size in bytes"
    - uncompressed_heap_size:
        usage: "GAUGE"
        description: "Uncompressed heap size in bytes"

# LICS-specific application metrics
lics_devices:
  query: |
    SELECT
      status,
      COUNT(*) as count
    FROM devices
    GROUP BY status
  metrics:
    - status:
        usage: "LABEL"
        description: "Device status"
    - count:
        usage: "GAUGE"
        description: "Number of devices with this status"

lics_experiments:
  query: |
    SELECT
      status,
      COUNT(*) as count
    FROM experiments
    GROUP BY status
  metrics:
    - status:
        usage: "LABEL"
        description: "Experiment status"
    - count:
        usage: "GAUGE"
        description: "Number of experiments with this status"

lics_active_sessions:
  query: |
    SELECT COUNT(*) as active_sessions
    FROM pg_stat_activity
    WHERE state = 'active'
  master: true
  metrics:
    - active_sessions:
        usage: "GAUGE"
        description: "Number of active database sessions"