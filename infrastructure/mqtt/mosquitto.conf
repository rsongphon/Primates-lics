# LICS Production MQTT Broker Configuration
# Eclipse Mosquitto Configuration for Production Environment

# =============================================================================
# General Settings
# =============================================================================

# Run as a daemon
user mosquitto

# Maximum number of client connections
max_connections 10000

# Maximum number of messages to hold in memory per client
max_queued_messages 1000

# Maximum inflight messages per client
max_inflight_messages 50

# Memory limit for message store (MB)
memory_limit 512

# =============================================================================
# Persistence Settings
# =============================================================================

# Enable persistence
persistence true
persistence_location /mosquitto/data/

# Save persistence every 1800 seconds (30 minutes)
autosave_interval 1800

# Save to disk if unflushed messages > 100
autosave_on_changes true

# =============================================================================
# Logging
# =============================================================================

# Log to file
log_dest file /mosquitto/log/mosquitto.log

# Log types to enable
log_type error
log_type warning
log_type notice
log_type information

# Log connections
connection_messages true

# Log timestamps
log_timestamp true
log_timestamp_format %Y-%m-%dT%H:%M:%S

# =============================================================================
# Default Listener (MQTT)
# =============================================================================

# MQTT listener on port 1883
listener 1883
protocol mqtt

# Maximum QoS level allowed
max_qos 2

# Allow retain messages
retain_available true

# =============================================================================
# WebSocket Listener
# =============================================================================

# WebSocket listener on port 9001
listener 9001
protocol websockets

# HTTP directory for WebSocket files
http_dir /usr/share/mosquitto/www

# =============================================================================
# Security Settings
# =============================================================================

# Disable anonymous access in production
allow_anonymous false

# Password file location
password_file /mosquitto/config/passwords.txt

# ACL file for topic-based authorization
acl_file /mosquitto/config/acl.txt

# Cache ACL lookups for performance
# acl_cache_seconds 300  # Not supported in Mosquitto 2.0

# Enable connection and subscription logging for security audit
connection_messages true
log_dest topic

# =============================================================================
# TLS/SSL Settings (for production)
# =============================================================================

# TLS listener on port 8883 (uncomment for production with SSL)
# listener 8883
# protocol mqtt

# SSL certificate files
# cafile /mosquitto/config/ca.crt
# certfile /mosquitto/config/server.crt
# keyfile /mosquitto/config/server.key

# Require certificate from clients
# require_certificate true

# Use identity from certificate CN
# use_identity_as_username true

# TLS version
# tls_version tlsv1.2

# =============================================================================
# Per-client Message Limits
# =============================================================================

# Maximum message size (64KB)
max_packet_size 65536

# Maximum topic length
max_topic_alias 65535

# Topic alias maximum
# topic_alias_maximum 10  # Not supported in Mosquitto 2.0

# =============================================================================
# Bridge Configuration (for multi-broker setup)
# =============================================================================

# Bridge to cloud MQTT if needed
# connection cloud-bridge
# address cloud-mqtt.lics.io:8883
# bridge_protocol_version mqttv311
# topic lics/bridge/# both 0 "" ""
# bridge_cafile /mosquitto/config/cloud-ca.crt
# bridge_certfile /mosquitto/config/bridge.crt
# bridge_keyfile /mosquitto/config/bridge.key

# =============================================================================
# Plugin Configuration
# =============================================================================

# Auth plugin (if using external authentication)
# auth_plugin /usr/lib/mosquitto_auth.so

# Auth plugin options
# auth_opt_backends files
# auth_opt_password_file /mosquitto/config/passwords.txt
# auth_opt_acl_file /mosquitto/config/acl.txt

# =============================================================================
# Performance Tuning
# =============================================================================

# Disable Nagle algorithm for better performance
# set_tcp_nodelay true

# SO_REUSEADDR option
# so_reuseaddr true

# Client will timeout after 60 seconds of inactivity
# keepalive_timeout 60

# =============================================================================
# Statistics and Monitoring
# =============================================================================

# Enable $SYS topics for monitoring
# sys_interval 60

# =============================================================================
# Additional Security
# =============================================================================

# Disable bridge mode (security)
allow_zero_length_clientid false

# Client ID prefix requirements
# clientid_prefixes lics-device-,lics-backend-

# Maximum client ID length
# max_clientid_len 64  # Not supported in Mosquitto 2.0

# Upgrade QoS 0 to QoS 1 for critical topics
# upgrade_outgoing_qos true